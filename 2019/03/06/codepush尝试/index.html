<!DOCTYPE html>
<html lang="Zh-cn">


<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>
    CodePush尝试 | 码客库
  </title>
  <meta name="description" content="爱生活、爱技术、爱分享">
  
  <meta name="keywords" content="
  codepush,热更新
  ">
  
  <meta name="author" content="zxy">

  <meta http-equiv="Cache-Control" content="no-transform"/>
  <meta http-equiv="Cache-Control" content="no-siteapp">

  <link rel="icon" type="image/x-icon" href="">
  <link rel="stylesheet" href="/css/main.css">
  <link rel="stylesheet"
        href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
  

  

  <script src="//cdnjs.cloudflare.com/ajax/libs/vue/1.0.25-csp/vue.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.11.2/moment.min.js"></script>
</head>

<body id="replica-app">

<nav class="navbar-wrapper">
  <div class="navbar">
    <div class="container clearfix">
      <a href="/" class="navbar-logo"><i class="fa fa-github"></i></a>

      <div class="navbar-search float-left desktop-only">
        <div class="navbar-search-form">
          <label for="gsc-i-id1">This website</label>
          <div id="google-search">
            <gcse:search></gcse:search>
          </div>
        </div>
      </div>

      <ul class="navbar-nav float-left">
        
        <li><a href="/archives">Archives</a></li>
        
        <!-- 
        <li><a href="/categories">Categories</a></li>
        
        
        <li><a href="/tags">Tags</a></li>
         -->
        
        <li class="desktop-only"><a href="/atom.xml" target="_blank">RSS</a></li>
        
      </ul>

      <ul class="navbar-nav user-nav float-right desktop-only">
        <li class="user-nav-notification">
          <a><span class="user-nav-unread"></span><i class="fa fa-bell"></i></a>
        </li>
        <li>
          <a><i class="fa fa-plus"></i> <i class="fa fa-caret-down"></i></a>
        </li>
        <li class="user-nav-logo">
          <a><img src="https://avatars1.githubusercontent.com/u/17245817?s=460&amp;v=4"> <i class="fa fa-caret-down"></i></i></a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="main-container">
  <header class="header-wrapper desktop-only">
  <div class="container header-site-detail">
    <ul class="header-toolbar">
      <li class="clearfix">
        <a href="/archives" class="header-toolbar-left"><i
                  class="fa fa-file-text"></i> Posts </a>
        <a href="/archives"
           class="header-toolbar-right"> 24 </a>
      </li>
      <!-- <li>
        <a href="/tags" class="header-toolbar-left"><i
                  class="fa fa-tags"></i> Tags </a>
        <a href="/tags"
           class="header-toolbar-right"> 28 </a>
      </li>
      <li>
        <a href="/categories" class="header-toolbar-left"><i
                  class="fa fa-folder-open"></i> Categories </a>
        <a href="/categories"
           class="header-toolbar-right"> 15 </a>
      </li> -->
    </ul>
    <h2 class="header-title">
      <i class="fa fa-book text-muted"></i>
      <a href="/">码客库</a>
      
      
    </h2>
  </div>

  <div class="container">
    <div class="header-tab-wrapper clearfix">
      <span class="header-tab header-tab-selected"><i class="fa fa-thumbs-o-up"></i> Like</span>
      <span class="header-tab"><i class="fa fa-share-alt"></i> Share</span>
      <span class="header-tab"><i class="fa fa-comments-o"></i> Discussion</span>
      <span class="header-tab"><i class="fa fa-bookmark-o"></i> Bookmark </span>
      <span class="header-tab"><i class="fa fa-smile-o"></i> Smile <i class="fa fa-caret-down"></i></span>
    </div>
  </div>
</header>


<div class="post-container container">
  <h3>
    <i class="fa fa-user-o"></i>
    zxy

    <span class="post-date float-right" title="{{moment(1551877177224).format('MMM DD, YYYY, h:mm:ss A')}}">
      <i class="fa fa-pencil-square-o"></i>
      {{moment(1551877177224).fromNow()}}
    </span>
  </h3>

  <article class="post-content">
    <h1>CodePush尝试</h1>
    <h1 id="1、热更新技术"><a href="#1、热更新技术" class="headerlink" title="1、热更新技术"></a>1、热更新技术</h1><ul>
<li>采用微软code-push技术方案<h2 id="1-1-react-native-实践步骤"><a href="#1-1-react-native-实践步骤" class="headerlink" title="1.1 react-native 实践步骤"></a>1.1 react-native 实践步骤</h2></li>
<li>安装code-push服务 npm install -g code-push-cli</li>
<li>注册code-push账号<ul>
<li>1、运行cmd 输入 code-push register</li>
<li>2、会自动弹出注册地址</li>
<li>3、选择使用github账号来关联注册</li>
<li>4、注册好以后 网站后返回一个key 复制好后即可登录使用code-push服务了</li>
</ul>
</li>
<li>登录code-push<ul>
<li>1、运行cmd 输入 code-push login</li>
<li>2、根据提示 网站里复制好的key</li>
</ul>
</li>
<li><p>添加code-push app应用</p>
<ul>
<li><p>1、运行cmd 输入 code-push app add &lt;应用程序名&gt; &lt;平台名&gt; &lt;开发平台(语言)&gt;</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">code-push app add testApp android react-native</span><br><span class="line">code-push app add testApp android cordova</span><br><span class="line">code-push app add testApp android java</span><br><span class="line"></span><br><span class="line">code-push app add testApp ios react-native</span><br><span class="line">code-push app add testApp ios cordova</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
<li><p>2、获取此应用的Deployment Key</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">code-push deployment list maxdog-android -k</span><br></pre></td></tr></table></figure>
<p>  返回如下信息：Production(发布成品时使用) Staging(测试使用)</p>
  <figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">┌────────────┬──────────────────────────────────────────────────────────────────┬───────────────────────────────┬───── ─────────────────┐</span><br><span class="line">│ Name       │ Deployment Key                                                   │ Update Metadata               │ Install Metrics       │</span><br><span class="line">├────────────┼──────────────────────────────────────────────────────────────────┼───────────────────────────────┼───── ─────────────────┤</span><br><span class="line">│ Production │ <span class="number">263</span>WfI5kF2JfNWkuETEaSXvPfg6P3f4257f6<span class="number">-02</span>c1<span class="number">-42</span>ed-bc32<span class="number">-7147497</span>c4640 │ No updates released           │ No installs recorded  │</span><br><span class="line">├────────────┼──────────────────────────────────────────────────────────────────┼───────────────────────────────┼───── ─────────────────┤</span><br><span class="line">│ Staging    │ UkYG0AtUSNHiwy9np-BM6APslQi23f4257f6<span class="number">-02</span>c1<span class="number">-42</span>ed-bc32<span class="number">-7147497</span>c4640 │ Label: v11                    │ No installs recorded  │</span><br><span class="line">│            │                                                                  │ App Version: <span class="number">1.0</span>              │                       │</span><br><span class="line">│            │                                                                  │ Mandatory: Yes                │                       │</span><br><span class="line">│            │                                                                  │ Release Time: <span class="number">3</span> days ago      │                       │</span><br><span class="line">│            │                                                                  │ Released By: <span class="number">654207967</span>@qq.com │                       │</span><br><span class="line">│            │                                                                  │ Description: 测试更新android包  │                       │</span><br><span class="line">└────────────┴──────────────────────────────────────────────────────────────────┴───────────────────────────────┴───── ─────────────────┘</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>创建react-native 项目</p>
<ul>
<li>1、运行cmd 输入 react-native init testApp</li>
<li><p>2、安装插件</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm i --save react-native-code-push</span><br><span class="line">npm i --save appcenter appcenter-analytics appcenter-crashes</span><br></pre></td></tr></table></figure>
</li>
<li><p>3、编译链接插件<br>  运行cmd 输入 react-native link</p>
<pre><code>- 注意 如果提示link command不存在 则先在根项目路径上执行 npm install
</code></pre></li>
<li><p>4、输入对应的key值</p>
<ul>
<li>注意,在link 编译链接时候：<br>  react-native-code-push 使用的key 是deployment key (Production / Staging)中任意一个都行<br>  appcenter appcenter-analytics appcenter-crashes 使用的key是应用的APP SECRET。在App Center网站对应的项目Getting Started页面可以查询到</li>
</ul>
</li>
<li><p>react-native App中集成code-push</p>
<ul>
<li>1、在入口index.js(或者主组件页面)中，引用code-push<br>  import codePush from “react-native-code-push”;<br>  import { AppState } from “react-native”;</li>
<li>2、在入口组件中的componentDidMount函数中添加以下代码：  <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">    componentDidMount() &#123;</span><br><span class="line">        ...</span><br><span class="line">        AppState.addEventListener(<span class="string">"change"</span>, (newState) =&gt; &#123;</span><br><span class="line">            newState === <span class="string">"active"</span> &amp;&amp; codePush.sync(&#123;</span><br><span class="line">                updateDialog: &#123;</span><br><span class="line">                appendReleaseDescription: <span class="literal">true</span>, <span class="comment">// 显示更新内容</span></span><br><span class="line">                descriptionPrefix: <span class="string">'\n\n更新内容：\n'</span>,</span><br><span class="line">                title: <span class="string">'版本更新'</span>,</span><br><span class="line">                mandatoryUpdateMessage: <span class="string">''</span>,</span><br><span class="line">                mandatoryContinueButtonLabel: <span class="string">'立即更新'</span>,</span><br><span class="line">                &#125;,</span><br><span class="line">                mandatoryInstallMode: codePush.InstallMode.IMMEDIATE,</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p>发布应用</p>
<ul>
<li>1、首先手动在项目跟目录下的 [android/app/src/main] 文件目录下建立一个assets文件夹</li>
<li><p>2、然后cmd 进入项目的根目录下执行(打包js及图片生存bundle文件)：</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">react-native bundle --platform android --dev false --entry-file index.js --bundle-output android/app/src/main/assets/index.android.bundle --assets-dest android/app/src/main/res</span><br></pre></td></tr></table></figure>
</li>
<li><p>3、最后cmd 执行 react-native run-android 生存apk文件(安装在真机上等待测试)</p>
</li>
</ul>
</li>
<li><p>更新测试</p>
<ul>
<li>1、手动修改js代码或者图片</li>
<li><p>2、创建一个文件夹 保存新的bundle文件</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir bundle</span><br></pre></td></tr></table></figure>
</li>
<li><p>3、打包新的bundle文件</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">react-native bundle --platform android --entry-file index.js --bundle-output ./bundle/index.android.bundle --assets-dest ./bundle/assets --dev false</span><br></pre></td></tr></table></figure>
</li>
<li><p>4、发布更新</p>
  <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">        code-push release MaxDog-android .\bundle\index.android.bundle 1.0 --description "aaaaa" --mandatory true</span><br><span class="line"></span><br><span class="line">        其中：版本1.0 是对应的安装版本 即 在build.gradle 中 android.defaultConfig.versionName对应的值</span><br><span class="line">        --description "aaaaa" 代表更新描述</span><br><span class="line">        --mandatory true 代表强制更新</span><br><span class="line">        ```shell</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span># 1.2 cordova-android@6.2.3 实践步骤</span><br><span class="line"></span><br><span class="line">```shell</span><br><span class="line">cordova plugin add cordova-plugin-code-push@latest</span><br><span class="line"></span><br><span class="line">注意：1.1.1版本中</span><br><span class="line">由于 cordova-plugin-code-push的config.xml中</span><br><span class="line">&lt;hook type="before_plugin_install" src="scripts/beforeInstall.js" /&gt;</span><br><span class="line">scripts/beforeInstall.js 路径配置有误, 应该是</span><br><span class="line">&lt;hook type="before_plugin_install" src="hooks/beforeInstall.js" /&gt;</span><br><span class="line">导致一些包没下载到,需要手动下载一些包：</span><br><span class="line">cordova plugin add cordova-plugin-file@3.0.0</span><br><span class="line">cordova plugin add cordova-plugin-file-transfer@1.4.0</span><br><span class="line">cordova plugin add cordova-plugin-zip</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>With the CodePush plugin installed, configure your app to use it via the following steps:</p>
<ol>
<li><p>Add your deployment keys to the <code>config.xml</code> file, making sure to include the right key for each Cordova platform:</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">platform</span> <span class="attr">name</span>=<span class="string">"android"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">preference</span> <span class="attr">name</span>=<span class="string">"CodePushDeploymentKey"</span> <span class="attr">value</span>=<span class="string">"YOUR-ANDROID-DEPLOYMENT-KEY"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">platform</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">platform</span> <span class="attr">name</span>=<span class="string">"ios"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">preference</span> <span class="attr">name</span>=<span class="string">"CodePushDeploymentKey"</span> <span class="attr">value</span>=<span class="string">"YOUR-IOS-DEPLOYMENT-KEY"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">platform</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>If you’re using an <code>&lt;access origin=&quot;*&quot; /&gt;</code> element in your <code>config.xml</code> file, then your app is already allowed to communicate with the CodePush servers and you can safely skip this step. Otherwise, add the following additional <code>&lt;access /&gt;</code> elements:</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">access</span> <span class="attr">origin</span>=<span class="string">"https://codepush.azurewebsites.net"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">access</span> <span class="attr">origin</span>=<span class="string">"https://codepush.blob.core.windows.net"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">access</span> <span class="attr">origin</span>=<span class="string">"https://codepushupdates.azureedge.net"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>To ensure that your app can access the CodePush server on <a href="https://developer.mozilla.org/en-US/docs/Web/Security/CSP/Introducing_Content_Security_Policy" target="_blank" rel="noopener">CSP</a>-compliant platforms, add <code>https://codepush.azurewebsites.net</code> to the <code>Content-Security-Policy</code> <code>meta</code> tag in your <code>index.html</code> file:</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Content-Security-Policy"</span> <span class="attr">content</span>=<span class="string">"default-src https://codepush.azurewebsites.net 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>发布更新(两种方式)</p>
 <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">code-push release-cordova danger-android(项目名) android(平台) --description "gengxinceshi"</span><br><span class="line">code-push release danger-android(项目名) ./platforms/android/assets/www(位置) 1.0.0(对应版本) --description "测试"</span><br></pre></td></tr></table></figure>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">codePush.checkForUpdate(<span class="function"><span class="keyword">function</span> (<span class="params">update</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!update) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"The app is up to date."</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        codePush.sync(<span class="literal">null</span>, &#123;</span><br><span class="line">            updateDialog: &#123;</span><br><span class="line">                appendReleaseDescription: <span class="literal">true</span>, <span class="comment">// 显示更新内容</span></span><br><span class="line">                descriptionPrefix: <span class="string">'更新内容：\n'</span>,</span><br><span class="line">                updateTitle: <span class="string">'版本更新'</span>,</span><br><span class="line">                optionalUpdateMessage : <span class="string">'有更新内容，请立刻执行更新！'</span>,</span><br><span class="line">                mandatoryUpdateMessage: <span class="string">"有更新内容，请立刻执行更新！"</span>,</span><br><span class="line">                optionalIgnoreButtonLabel: <span class="string">"忽略"</span>,</span><br><span class="line">                optionalInstallButtonLabel: <span class="string">"立即更新"</span>, <span class="comment">// 可选更新时候的 按钮</span></span><br><span class="line">                mandatoryContinueButtonLabel: <span class="string">'立即更新'</span>,   <span class="comment">// 强制更新时候的 按钮</span></span><br><span class="line">            &#125;,</span><br><span class="line">            installMode: InstallMode.IMMEDIATE</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="命令使用"><a href="#命令使用" class="headerlink" title="命令使用"></a>命令使用</h3><ol>
<li><p>发布<br>code-push release ElephantApp-ios ./ios-bundle/ 0.2.0 –d Production –description ‘新功能更新’ –mandatory true （强制更新）</p>
</li>
<li><p>清除历史部署记录<br>code-push deployment clear <appname> Production or Staging</appname></p>
</li>
<li><p>回滚<br>code-push rollback <appname> Production –targetRelease v4(codepush服务部署的版本号)</appname></p>
</li>
</ol>

  </article>
</div>


    




</div>

<div class="footer-wrapper container">
  <footer class="footer clearfix">
    <div class="clearfix">
    <a href="https://github.com/zxyty" class="footer-logo">
      <i class="fa fa-github"></i>
    </a>
    <ul class="footer-social-link">
      <li>© 2018 zxy</li>
      <li><a href="https://github.com/zxyty">Home</a></li>
      
      <li><a href="https://github.com/zxyty">Github</a></li>
      
    </ul>
    <div class="footer-theme-info">
      Theme <a href="//github.com/sabrinaluo/hexo-theme-replica">Replica</a>
      by <a href="//github.com/sabrinaluo">Hiitea</a> ❤ Powered by Hexo
    </div>
    </div>
    
  </footer>
</div>



<script src="/js/main.js"></script>

</body>
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script>
</html>
