

<!DOCTYPE html>
<html lang="zh-CN">
  <head><meta name="generator" content="Hexo 3.9.0">
    <title>CodePush尝试 — zxyty</title>
    <meta charset="utf-8">
    <meta name="msapplication-TileColor" content="#4fc08d">
    <meta name="theme-color" content="#4fc08d">

    <link rel="manifest" href="/manifest.json">

    <link href="//code.bdstatic.com/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">

    <!-- main page styles -->
    <link rel="stylesheet" href="/css/page.css">

    <script>
      window.PAGE_TYPE = "post"
    </script>

  </head>
  <body class="docs">
    <div id="mobile-bar">
      <a class="menu-button"></a>
      <a class="logo" href="/"></a>
    </div>
    <header id="header">
  <a id="logo" href="/">
    <span>满堂大杂烩</span>
  </a>
  <ul id="nav">
    <li class="nav-dropdown-container learn">
  <a class="nav-link">组件</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li>
      <ul>
        <li><a href="/guide/" class="nav-link">文档</a></li>
        <li><a href="/api/" class="nav-link">API</a></li>
      </ul>
    </li>
  </ul>
</li>

<li class="nav-dropdown-container resources">
  <a href="/blog/" class="nav-link current">文章</a>
</li>

<li class="nav-dropdown-container resources">
    <a href="/about/" class="nav-link">关于</a>
</li>


  </ul>
</header>

    
      <div id="main" class="fix-sidebar">
        
  

<div class="sidebar">
  <div class="sidebar-inner">
    
    <div class="list">
      <ul class="menu-root">
  
    
    <li>
      <a href="/blog/index.html" class="sidebar-link">文章</a>
    </li>
  
    
    <li>
      <a href="/blog/基于后缀算术表达式的代码解析.html" class="sidebar-link">基于后缀算术表达式的代码解析</a>
    </li>
  
    
    <li>
      <a href="/blog/基于AST的算数表达式解析.html" class="sidebar-link">基于AST的算数表达式解析</a>
    </li>
  
    
    <li>
      <a href="/blog/vscode-java 环境配置.html" class="sidebar-link">Vscode Java 环境配置</a>
    </li>
  
    
    <li>
      <a href="/blog/纯前端实现图片的模板匹配.html" class="sidebar-link">纯前端实现图片的模板匹配</a>
    </li>
  
    
    <li>
      <a href="/blog/测试用例管理工具Luckyframe安装.html" class="sidebar-link">测试用例管理工具Luckyframe安装</a>
    </li>
  
    
    <li>
      <a href="/blog/Vscode远程开发，本地翻墙神器.html" class="sidebar-link">Vscode远程开发，本地翻墙神器</a>
    </li>
  
    
    <li>
      <a href="/blog/node/2020年Node新功能/2020Node新增功能.html" class="sidebar-link">Node 2020年新增功能</a>
    </li>
  
    
    <li>
      <a href="/blog/yum-404-error.html" class="sidebar-link">yum-404-error</a>
    </li>
  
    
    <li>
      <a href="/blog/React16/react fiber reconciler解密.html" class="sidebar-link">react16特性：fiber reconciler解密</a>
    </li>
  
    
    <li>
      <a href="/blog/cmd终端设置代理.html" class="sidebar-link">cmd终端设置代理</a>
    </li>
  
    
    <li>
      <a href="/blog/前端面试题收集.html" class="sidebar-link">前端面试题收集</a>
    </li>
  
    
    <li>
      <a href="/blog/git子模块.html" class="sidebar-link">git子模块</a>
    </li>
  
    
    <li>
      <a href="/blog/算法探索-排序.html" class="sidebar-link">算法-排序</a>
    </li>
  
    
    <li>
      <a href="/blog/linux安装python-pyenv环境.html" class="sidebar-link">linux安装python-pyenv环境</a>
    </li>
  
    
    <li>
      <a href="/blog/开发人员良心工具.html" class="sidebar-link">开发人员良心工具</a>
    </li>
  
    
    <li>
      <a href="/blog/斐波拉契数列.html" class="sidebar-link">斐波拉契数列js实现</a>
    </li>
  
    
    <li>
      <a href="/blog/数组ArrayFlatten.html" class="sidebar-link">数组ArrayFlatten</a>
    </li>
  
    
    <li>
      <a href="/blog/极光推送.html" class="sidebar-link">极光推送RN集成</a>
    </li>
  
    
    <li>
      <a href="/blog/Docker安装taiga项目.html" class="sidebar-link">Docker安装部署taiga项目</a>
    </li>
  
    
    <li>
      <a href="/blog/docker-pm2发布node服务.html" class="sidebar-link">docker-pm2发布node服务</a>
    </li>
  
    
    <li>
      <a href="/blog/git-pull获取指定文件.html" class="sidebar-link">git-pull获取指定文件</a>
    </li>
  
    
    <li>
      <a href="/blog/git获取第一次commit.html" class="sidebar-link">git获取第一次commit提交记录</a>
    </li>
  
    
    <li>
      <a href="/blog/ReactNative项目选型设计.html" class="sidebar-link">ReactNative项目选型设计</a>
    </li>
  
    
    <li>
      <a href="/blog/docker-Mysql8.0安装初始化配置.html" class="sidebar-link">Docker-Mysql8.0安装及初始化配置</a>
    </li>
  
    
    <li>
      <a href="/blog/DDA.html" class="sidebar-link">DDA算法</a>
    </li>
  
    
    <li>
      <a href="/blog/ubuntu搭建shadowsocks服务.html" class="sidebar-link">ubuntu搭建shadowsocks服务</a>
    </li>
  
    
    <li>
      <a href="/blog/React-Native 接入百度统计.html" class="sidebar-link">React-Native 接入百度统计SDK</a>
    </li>
  
    
    <li>
      <a href="/blog/docker-使用yum安装.html" class="sidebar-link">docker-使用yum安装</a>
    </li>
  
    
    <li>
      <a href="/blog/前端入门介绍.html" class="sidebar-link">前端入门篇</a>
    </li>
  
    
    <li>
      <a href="/blog/codepush尝试.html" class="sidebar-link current">CodePush尝试</a>
    </li>
  
    
    <li>
      <a href="/blog/markdown数学公式.html" class="sidebar-link">Markdown数学公式</a>
    </li>
  
    
    <li>
      <a href="/blog/Mongoose踩坑路.html" class="sidebar-link">Mongoose踩坑路</a>
    </li>
  
    
    <li>
      <a href="/blog/linux安装nginx.html" class="sidebar-link">linux安装nginx</a>
    </li>
  
    
    <li>
      <a href="/blog/linux系统nvm安装.html" class="sidebar-link">linux系统nvm指定版本安装</a>
    </li>
  
    
    <li>
      <a href="/blog/Vscode-Threejs代码智能提示.html" class="sidebar-link">Vscode-Threejs代码智能提示</a>
    </li>
  
    
    <li>
      <a href="/blog/linux常用命令.html" class="sidebar-link">linux常用命令</a>
    </li>
  
    
    <li>
      <a href="/blog/thanks.html" class="sidebar-link">说明</a>
    </li>
  
</ul>

    </div>
  </div>
</div>


<div class="content post with-sidebar ">
  
  
    
      <h1>CodePush尝试</h1>
    
  
    
      
        <span>六月 06, 2018</span>
      
    
  
    <h1 id="1、热更新技术"><a href="#1、热更新技术" class="headerlink" title="1、热更新技术"></a>1、热更新技术</h1><ul>
<li>采用微软code-push技术方案<h2 id="1-1-react-native-实践步骤"><a href="#1-1-react-native-实践步骤" class="headerlink" title="1.1 react-native 实践步骤"></a>1.1 react-native 实践步骤</h2></li>
<li>安装code-push服务 npm install -g code-push-cli</li>
<li>注册code-push账号<ul>
<li>1、运行cmd 输入 code-push register</li>
<li>2、会自动弹出注册地址</li>
<li>3、选择使用github账号来关联注册</li>
<li>4、注册好以后 网站后返回一个key 复制好后即可登录使用code-push服务了</li>
</ul>
</li>
<li>登录code-push<ul>
<li>1、运行cmd 输入 code-push login</li>
<li>2、根据提示 网站里复制好的key</li>
</ul>
</li>
<li><p>添加code-push app应用</p>
<ul>
<li><p>1、运行cmd 输入 code-push app add &lt;应用程序名&gt; &lt;平台名&gt; &lt;开发平台(语言)&gt;</p>
  <pre><code class="hljs shell">code-push app add testApp android react-native
code-push app add testApp android cordova
code-push app add testApp android java

code-push app add testApp ios react-native
code-push app add testApp ios cordova
...</code></pre>
</li>
<li><p>2、获取此应用的Deployment Key</p>
  <pre><code class="hljs shell">code-push deployment list maxdog-android -k</code></pre>
<p>  返回如下信息：Production(发布成品时使用) Staging(测试使用)</p>
  <pre><code class="hljs javascript">┌────────────┬──────────────────────────────────────────────────────────────────┬───────────────────────────────┬───── ─────────────────┐
│ Name       │ Deployment Key                                                   │ Update Metadata               │ Install Metrics       │
├────────────┼──────────────────────────────────────────────────────────────────┼───────────────────────────────┼───── ─────────────────┤
│ Production │ <span class="hljs-number">263</span>WfI5kF2JfNWkuETEaSXvPfg6P3f4257f6<span class="hljs-number">-02</span>c1<span class="hljs-number">-42</span>ed-bc32<span class="hljs-number">-7147497</span>c4640 │ No updates released           │ No installs recorded  │
├────────────┼──────────────────────────────────────────────────────────────────┼───────────────────────────────┼───── ─────────────────┤
│ Staging    │ UkYG0AtUSNHiwy9np-BM6APslQi23f4257f6<span class="hljs-number">-02</span>c1<span class="hljs-number">-42</span>ed-bc32<span class="hljs-number">-7147497</span>c4640 │ Label: v11                    │ No installs recorded  │
│            │                                                                  │ App Version: <span class="hljs-number">1.0</span>              │                       │
│            │                                                                  │ Mandatory: Yes                │                       │
│            │                                                                  │ Release Time: <span class="hljs-number">3</span> days ago      │                       │
│            │                                                                  │ Released By: <span class="hljs-number">654207967</span>@qq.com │                       │
│            │                                                                  │ Description: 测试更新android包  │                       │
└────────────┴──────────────────────────────────────────────────────────────────┴───────────────────────────────┴───── ─────────────────┘</code></pre>
</li>
</ul>
</li>
<li><p>创建react-native 项目</p>
<ul>
<li>1、运行cmd 输入 react-native init testApp</li>
<li><p>2、安装插件</p>
  <pre><code class="hljs shell">npm i --save react-native-code-push
npm i --save appcenter appcenter-analytics appcenter-crashes</code></pre>
</li>
<li><p>3、编译链接插件<br>  运行cmd 输入 react-native link</p>
<pre><code>- 注意 如果提示link command不存在 则先在根项目路径上执行 npm install
</code></pre></li>
<li><p>4、输入对应的key值</p>
<ul>
<li>注意,在link 编译链接时候：<br>  react-native-code-push 使用的key 是deployment key (Production / Staging)中任意一个都行<br>  appcenter appcenter-analytics appcenter-crashes 使用的key是应用的APP SECRET。在App Center网站对应的项目Getting Started页面可以查询到</li>
</ul>
</li>
<li><p>react-native App中集成code-push</p>
<ul>
<li>1、在入口index.js(或者主组件页面)中，引用code-push<br>  import codePush from “react-native-code-push”;<br>  import { AppState } from “react-native”;</li>
<li>2、在入口组件中的componentDidMount函数中添加以下代码：  <pre><code class="hljs javascript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">App</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Component</span> </span>&#123;
    componentDidMount() &#123;
        ...
        AppState.addEventListener(<span class="hljs-string">"change"</span>, (newState) =&gt; &#123;
            newState === <span class="hljs-string">"active"</span> &amp;&amp; codePush.sync(&#123;
                <span class="hljs-attr">updateDialog</span>: &#123;
                <span class="hljs-attr">appendReleaseDescription</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 显示更新内容</span>
                <span class="hljs-attr">descriptionPrefix</span>: <span class="hljs-string">'\n\n更新内容：\n'</span>,
                <span class="hljs-attr">title</span>: <span class="hljs-string">'版本更新'</span>,
                <span class="hljs-attr">mandatoryUpdateMessage</span>: <span class="hljs-string">''</span>,
                <span class="hljs-attr">mandatoryContinueButtonLabel</span>: <span class="hljs-string">'立即更新'</span>,
                &#125;,
                <span class="hljs-attr">mandatoryInstallMode</span>: codePush.InstallMode.IMMEDIATE,
            &#125;);
        &#125;);
        ...
    &#125;

    ...
&#125;</code></pre>
</li>
</ul>
</li>
</ul>
</li>
<li><p>发布应用</p>
<ul>
<li>1、首先手动在项目跟目录下的 [android/app/src/main] 文件目录下建立一个assets文件夹</li>
<li><p>2、然后cmd 进入项目的根目录下执行(打包js及图片生存bundle文件)：</p>
  <pre><code class="hljs shell">react-native bundle --platform android --dev false --entry-file index.js --bundle-output android/app/src/main/assets/index.android.bundle --assets-dest android/app/src/main/res</code></pre>
</li>
<li><p>3、最后cmd 执行 react-native run-android 生存apk文件(安装在真机上等待测试)</p>
</li>
</ul>
</li>
<li><p>更新测试</p>
<ul>
<li>1、手动修改js代码或者图片</li>
<li><p>2、创建一个文件夹 保存新的bundle文件</p>
  <pre><code class="hljs shell">mkdir bundle</code></pre>
</li>
<li><p>3、打包新的bundle文件</p>
  <pre><code class="hljs shell">react-native bundle --platform android --entry-file index.js --bundle-output ./bundle/index.android.bundle --assets-dest ./bundle/assets --dev false</code></pre>
</li>
<li><p>4、发布更新</p>
  <pre><code class="hljs shell">code-push release MaxDog-android .\bundle\index.android.bundle 1.0 --description "aaaaa" --mandatory true

其中：版本1.0 是对应的安装版本 即 在build.gradle 中 android.defaultConfig.versionName对应的值
--description "aaaaa" 代表更新描述
--mandatory true 代表强制更新</code></pre>
</li>
</ul>
</li>
</ul>
<h2 id="1-2-cordova-android-6-2-3-实践步骤"><a href="#1-2-cordova-android-6-2-3-实践步骤" class="headerlink" title="1.2 cordova-android@6.2.3 实践步骤"></a>1.2 <a href="mailto:cordova-android@6.2.3" target="_blank" rel="noopener">cordova-android@6.2.3</a> 实践步骤</h2><pre><code class="hljs shell">cordova plugin add cordova-plugin-code-push@latest

注意：1.1.1版本中
由于 cordova-plugin-code-push的config.xml中
&lt;hook type="before_plugin_install" src="scripts/beforeInstall.js" /&gt;
scripts/beforeInstall.js 路径配置有误, 应该是
&lt;hook type="before_plugin_install" src="hooks/beforeInstall.js" /&gt;
导致一些包没下载到,需要手动下载一些包：
cordova plugin add cordova-plugin-file@3.0.0
cordova plugin add cordova-plugin-file-transfer@1.4.0
cordova plugin add cordova-plugin-zip</code></pre>
<p>With the CodePush plugin installed, configure your app to use it via the following steps:</p>
<ol>
<li><p>Add your deployment keys to the <code>config.xml</code> file, making sure to include the right key for each Cordova platform:</p>
 <pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">platform</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"android"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">preference</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"CodePushDeploymentKey"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"YOUR-ANDROID-DEPLOYMENT-KEY"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">platform</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">platform</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"ios"</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">preference</span> <span class="hljs-attr">name</span>=<span class="hljs-string">"CodePushDeploymentKey"</span> <span class="hljs-attr">value</span>=<span class="hljs-string">"YOUR-IOS-DEPLOYMENT-KEY"</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">platform</span>&gt;</span></code></pre>
</li>
<li><p>If you’re using an <code>&lt;access origin=&quot;*&quot; /&gt;</code> element in your <code>config.xml</code> file, then your app is already allowed to communicate with the CodePush servers and you can safely skip this step. Otherwise, add the following additional <code>&lt;access /&gt;</code> elements:</p>
 <pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">access</span> <span class="hljs-attr">origin</span>=<span class="hljs-string">"https://codepush.azurewebsites.net"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">access</span> <span class="hljs-attr">origin</span>=<span class="hljs-string">"https://codepush.blob.core.windows.net"</span> /&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">access</span> <span class="hljs-attr">origin</span>=<span class="hljs-string">"https://codepushupdates.azureedge.net"</span> /&gt;</span></code></pre>
</li>
<li><p>To ensure that your app can access the CodePush server on <a href="https://developer.mozilla.org/en-US/docs/Web/Security/CSP/Introducing_Content_Security_Policy" target="_blank" rel="noopener">CSP</a>-compliant platforms, add <code>https://codepush.azurewebsites.net</code> to the <code>Content-Security-Policy</code> <code>meta</code> tag in your <code>index.html</code> file:</p>
 <pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">http-equiv</span>=<span class="hljs-string">"Content-Security-Policy"</span> <span class="hljs-attr">content</span>=<span class="hljs-string">"default-src https://codepush.azurewebsites.net 'self' data: gap: https://ssl.gstatic.com 'unsafe-eval'; style-src 'self' 'unsafe-inline'; media-src *"</span> /&gt;</span></code></pre>
</li>
<li><p>发布更新(两种方式)</p>
 <pre><code class="hljs shell">code-push release-cordova danger-android(项目名) android(平台) --description "gengxinceshi"
code-push release danger-android(项目名) ./platforms/android/assets/www(位置) 1.0.0(对应版本) --description "测试"</code></pre>
 <pre><code class="hljs javascript">codePush.checkForUpdate(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">update</span>) </span>&#123;
    <span class="hljs-keyword">if</span> (!update) &#123;
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">"The app is up to date."</span>);
    &#125; <span class="hljs-keyword">else</span> &#123;
        codePush.sync(<span class="hljs-literal">null</span>, &#123;
            <span class="hljs-attr">updateDialog</span>: &#123;
                <span class="hljs-attr">appendReleaseDescription</span>: <span class="hljs-literal">true</span>, <span class="hljs-comment">// 显示更新内容</span>
                <span class="hljs-attr">descriptionPrefix</span>: <span class="hljs-string">'更新内容：\n'</span>,
                <span class="hljs-attr">updateTitle</span>: <span class="hljs-string">'版本更新'</span>,
                <span class="hljs-attr">optionalUpdateMessage</span> : <span class="hljs-string">'有更新内容，请立刻执行更新！'</span>,
                <span class="hljs-attr">mandatoryUpdateMessage</span>: <span class="hljs-string">"有更新内容，请立刻执行更新！"</span>,
                <span class="hljs-attr">optionalIgnoreButtonLabel</span>: <span class="hljs-string">"忽略"</span>,
                <span class="hljs-attr">optionalInstallButtonLabel</span>: <span class="hljs-string">"立即更新"</span>, <span class="hljs-comment">// 可选更新时候的 按钮</span>
                <span class="hljs-attr">mandatoryContinueButtonLabel</span>: <span class="hljs-string">'立即更新'</span>,   <span class="hljs-comment">// 强制更新时候的 按钮</span>
            &#125;,
            <span class="hljs-attr">installMode</span>: InstallMode.IMMEDIATE
        &#125;);
    &#125;
&#125;);</code></pre>
</li>
</ol>
<h3 id="命令使用"><a href="#命令使用" class="headerlink" title="命令使用"></a>命令使用</h3><ol>
<li><p>发布<br>code-push release ElephantApp-ios ./ios-bundle/ 0.2.0 –d Production –description ‘新功能更新’ –mandatory true （强制更新）</p>
</li>
<li><p>清除历史部署记录<br>code-push deployment clear <appname> Production or Staging</appname></p>
</li>
<li><p>回滚<br>code-push rollback <appname> Production –targetRelease v4(codepush服务部署的版本号)</appname></p>
</li>
</ol>

    
    
      <div class="guide-links">
        
        
          <span>← <a href="/blog/Mongoose踩坑路.html">Mongoose踩坑路</a></span>
        
        
        
          <span style="float: right;"><a href="/blog/DDA.html">DDA算法</a> →</span>
        
      </div>
    
  
</div>

      </div>
      <script src="/js/smooth-scroll.min.js"></script>
    

    <!-- main custom script for sidebars, version selects etc. -->
    <script src="/js/css.escape.js"></script>
    <script src="/js/common.js"></script>
    

    <script type="text/javascript" src="https://cdn.bootcss.com/mathjax/2.7.6/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script>
  MathJax.Hub.Config({
    "HTML-CSS": {
      preferredFont: "TeX",
      availableFonts: ["STIX", "TeX"],
      linebreaks: {
        automatic: true
      },
      EqnChunk: (MathJax.Hub.Browser.isMobile ? 10 : 50)
    },
    tex2jax: {
      inlineMath: [
        ["$", "$"],
        ["\\(", "\\)"]
      ],
      processEscapes: true,
      ignoreClass: "tex2jax_ignore|dno",
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      noUndefined: {
        attributes: {
          mathcolor: "red",
          mathbackground: "#FFEEEE",
          mathsize: "90%"
        }
      },
      Macros: {
        href: "{}"
      }
    },
    messageStyle: "none"
  });
</script>
<script>
  function initialMathJax() {
    MathJax.Hub.Queue(function () {
      var all = MathJax.Hub.getAllJax(),
        i;
      // console.log(all);
      for (i = 0; i < all.length; i += 1) {
        console.log(all[i].SourceElement().parentNode)
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  }

  function reprocessMathJax() {
    if (typeof MathJax !== 'undefined') {
      MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
    }
  }
</script>

  </body>
</html>
